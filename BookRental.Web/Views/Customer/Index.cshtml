@model IEnumerable<CustomerViewModel>
@{
    ViewData["Title"] = "Customers";
    Layout = "_Layout";
}

<div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-900">Customers Management</h1>
            <button id="addCustomerBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                Add New Customer
            </button>
        </div>
    </div>

    <div class="p-6">
        <table id="customersTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Address</th>
                <th>City</th>
                <th>Actions</th>
            </tr>
            </thead>
        </table>
    </div>
</div>

<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="customerForm" class="needs-validation" novalidate>
                <div class="modal-body">
                    <input type="hidden" id="customerId" name="Id">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customerFirstName" name="FirstName" required maxlength="50" 
                                   pattern="^[a-zA-Z\s]+$" title="First name should only contain letters and spaces">
                            <div class="invalid-feedback">Please provide a valid first name (letters and spaces only).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customerLastName" name="LastName" required maxlength="50" 
                                   pattern="^[a-zA-Z\s]+$" title="Last name should only contain letters and spaces">
                            <div class="invalid-feedback">Please provide a valid last name (letters and spaces only).</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="customerAddress" class="form-label">Address <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="customerAddress" name="Address" rows="3" required maxlength="200"></textarea>
                            <div class="invalid-feedback">Please provide a valid address.</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="customerCity" class="form-label">City <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customerCity" name="City" required maxlength="100" 
                                   pattern="^[a-zA-Z\s]+$" title="City should only contain letters and spaces">
                            <div class="invalid-feedback">Please provide a valid city name (letters and spaces only).</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="validateAndSubmitCustomer()">
                        Save Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this customer?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    Delete Customer
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    let table;
    let customerToDelete = null;
    
    table = $('#customersTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
            url: '/Customer/GetCustomersData',
            type: 'GET'
        },
        columns: [
            { data: 'firstName' },
            { data: 'lastName' },
            { data: 'address' },
            { data: 'city' },
            { 
                data: 'id',
                orderable: false,
                searchable: false,
                render: function(data) {
                    return `
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" data-customer-id="${data}">
                                Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-btn" data-customer-id="${data}">
                                Delete
                            </button>
                        </div>
                    `;
                }
            }
        ],
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        order: [[0, 'asc']]
    });

    $('#addCustomerBtn').on('click', function() {
        $('#customerModalLabel').text('Add New Customer');
        resetForm('#customerForm');
        $('#customerId').val('');
        $('#customerModal').modal('show');
    });

    $(document).on('click', '.edit-btn', async function() {
        const customerId = $(this).data('customer-id');
        
        await apiGet(`/Customer/Details/${customerId}`, {
            onSuccess: (customer) => {
                $('#customerModalLabel').text('Edit Customer');
                resetForm('#customerForm');
                $('#customerId').val(customer.id);
                $('#customerFirstName').val(customer.firstName);
                $('#customerLastName').val(customer.lastName);
                $('#customerAddress').val(customer.address);
                $('#customerCity').val(customer.city);
                $('#customerModal').modal('show');
            }
        });
    });
    
    $(document).on('click', '.delete-btn', function() {
        customerToDelete = $(this).data('customer-id');
        $('#deleteModal').modal('show');
    });
    
    $('#confirmDelete').on('click', function() {
        if (customerToDelete) {
            apiDelete(`/Customer/Delete/${customerToDelete}`, {
                successMessage: 'Customer deleted successfully!',
                onSuccess: () => {
                    $('#deleteModal').modal('hide');
                    table.ajax.reload(null, false);
                    customerToDelete = null;
                }
            });
        }
    });

    function validateForm(formSelector) {
        const form = document.querySelector(formSelector);
        
        if (form.checkValidity()) {
            return true;
        }
        
        form.classList.add('was-validated');
        return false;
    }

    window.validateAndSubmitCustomer = function() {
        if (validateForm('#customerForm')) {
            const formData = new FormData(document.getElementById('customerForm'));
            const isEdit = document.getElementById('customerId').value !== '';
            const url = isEdit ? '/Customer/Edit' : '/Customer/Create';
            
            const submitBtn = document.querySelector('#customerModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'Saving...';
            submitBtn.disabled = true;

            apiPost(url, formData, {
                successMessage: `Customer ${isEdit ? 'updated' : 'created'} successfully!`,
                onSuccess: () => {
                    $('#customerModal').modal('hide');
                    table.ajax.reload(null, false);
                }
            }).finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }
    }

    function resetForm(formSelector) {
        const form = document.querySelector(formSelector);
        form.classList.remove('was-validated');
        form.reset();
    }
    
    $('#customerModal').on('hidden.bs.modal', function() {
        resetForm('#customerForm');
        $('#customerId').val('');
    });
    
    $('#deleteModal').on('hidden.bs.modal', function() {
        customerToDelete = null;
    });
});
</script>
}